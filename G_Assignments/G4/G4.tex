\documentclass[a4paper,12pt]{article}

% Standard configuration
\usepackage[english]{babel}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{hyperref}
\usepackage{setspace}
\onehalfspacing
\usepackage{upquote}
\usepackage{amsmath,amssymb}
\usepackage{tikz}
\usepackage[margin=1.3in]{geometry}
\usepackage[numbers]{natbib}

% Listings configuration
\usepackage{color}
\definecolor{listinggray}{gray}{0.9}
\usepackage{multirow,bigdelim}
\usepackage{listings}
\lstset{
	language=,
	literate=
		{æ}{{\ae}}1
		{ø}{{\o}}1
		{å}{{\aa}}1
		{Æ}{{\AE}}1
		{Ø}{{\O}}1
		{Å}{{\AA}}1,
	backgroundcolor=\color{listinggray},
	tabsize=3,
	rulecolor=,
	basicstyle=\scriptsize,
	upquote=true,
	aboveskip={1.5\baselineskip},
	columns=fixed,
	showstringspaces=false,
	extendedchars=true,
	breaklines=true,
	prebreak =\raisebox{0ex}[0ex][0ex]{\ensuremath{\hookleftarrow}},
	frame=single,
	showtabs=false,
	showspaces=false,
	showstringspaces=false,
	identifierstyle=\ttfamily,
	keywordstyle=\color[rgb]{0,0,1},
	commentstyle=\color[rgb]{0.133,0.545,0.133},
	stringstyle=\color[rgb]{0.627,0.126,0.941},
}
%captions on listings
\usepackage[center,font=small,labelfont=bf,textfont=it]{caption}

% Header configuration
\usepackage{fancyhdr}
\lhead[]{} %clear standard settings
\chead[]{} %clear standard settings
\rhead[]{} %\rightmark} %current section
\lfoot[]{} %clear standard settings
\cfoot[]{\thepage} %current page number 
\rfoot[]{} %clear standard settings

\title{OSM\\G assignment 4}
\author{Tobias Hallundbæk Petersen (xtv657)\\Ola Rønning (vdl761)\\Nikolaj Høyer (ctl533)}
\date{March 10\textsuperscript{th}, 2014}

\begin{document}
\maketitle
\tableofcontents
\newpage

\section{Task 1: TLB exception handling in Buenos}
The TLB load and store exceptions behave in almost the same way. Hence we will just show the code for load below. First, we retrieve the state of the offending thread. Then we check if the 13th most significant bit of the \texttt{badvaddr} of this thread is set or not and capture the result in the \texttt{is\_odd} variable - this checks if the page we wish to look up is odd or even.

We then look for a match between the \texttt{badvpn2} and \texttt{asid} fields of the offending thread and pages in the page table while also checking if the dirty bit is set. If a match is found, we move on to do a random TLB write. Otherwise we produce a kernel panic.

An important point is that we have chosen to throw a kernel panic both in the case of a kernel exception and a userland exception. We differentiate between the two by letting the TLB exception functions take a \texttt{kernelcall} argument which is either \texttt{0} (call from userland) or \texttt{1} (call from kernel). These values are hardcoded in the userland and kernel exception programs, like so:

\lstinputlisting[language=C, firstline=71, lastline=80]{../../proc/exception.c}
\texttt{proc/exception.c}

\lstinputlisting[language=C, firstline=82, lastline=91]{../../kernel/exception.c}
\texttt{kernel/exception.c}

\

From a user standpoint this is clearly bad, since for example a userland segfault would result in the kernel crashing, instead of doing something more sane - aborting the violating thread seems more reasonable. We see no apparent way of doing so, however, so we leave the code as it is. With our clear distinction between the two types of errors it is relatively simple to implement this in the future.
 
The code for the load exception part of \texttt{vm/tlb.c} is shown below.
\lstinputlisting[language=C, firstline=66, lastline=111]{../../vm/tlb.c}

The TLB modified exception is much more simple than load or store - we know that an error has occurred and we just need to differentiate between a userland and a kernel type. The code is shown below. 
\lstinputlisting[language=C, firstline=55, lastline=64]{../../vm/tlb.c}

\section{Task 2: Dynamic allocation for user processes}

\section{Task 3: Extended tests for TLB exceptions and user-space allocation}

\end{document}